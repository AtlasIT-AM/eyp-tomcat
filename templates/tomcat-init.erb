#!/bin/sh
# chkconfig: 345 20 99
# description: Tomcat
#. /etc/rc.d/init.d/functions
# Default-Start: 3 5
# Default-Stop: 0 6
#
# _____  ______ _____  _____  ______ _____       _______ ______ _____
# |  __ \|  ____|  __ \|  __ \|  ____/ ____|   /\|__   __|  ____|  __ \
# | |  | | |__  | |__) | |__) | |__ | |       /  \  | |  | |__  | |  | |
# | |  | |  __| |  ___/|  _  /|  __|| |      / /\ \ | |  |  __| | |  | |
# | |__| | |____| |    | | \ \| |___| |____ / ____ \| |  | |____| |__| |
# |_____/|______|_|    |_|  \_\______\_____/_/    \_\_|  |______|_____/
#
#

#
# puppet managed - DEPRECATED
#

# Variables de instancia

export   USER=<%= @user %>

<% if defined?(@javahome) %>
export   JAVA_HOME=<%= @javahome %>
<% end %>
<% if defined?(@jrehome) %>
export   JRE_HOME=<%= @jrehome %>
<% end %>
export   CATALINA_HOME=<%= @tomcatdir %>

export   CATALINA_OPTS="-Xmx<%= @xmx %> -Xms<%= @xms %>"
export   CATALINA_OPTS="$CATALINA_OPTS -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=8999 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false"
export   CATALINA_BASE=<%= @tomcatdir %>
export   CATALINA_PID=$CATALINA_BASE/tomcat.pid
export   CATALINA_TMPDIR=/tmp/$USER

if [ ! -d "$CATALINA_TMPDIR" ]
   then
        mkdir $CATALINA_TMPDIR
        chown $USER:$USER $CATALINA_TMPDIR
fi

if [ "$(id -n)" -eq "$(id -n <%= @user %>)" ];
then
  EXECSTART="/bin/bash"
else
  EXECSTART="su - ${USER}"
fi


case $1 in
'start')
        if [ -d ${CATALINA_BASE} ]
        then
                echo "Tomcat $USER starting"
                ${EXECSTART} -c "export CATALINA_HOME=$CATALINA_HOME; export CATALINA_BASE=$CATALINA_BASE; export CATALINA_OPTS=\"$CATALINA_OPTS\"; export CATALINA_PID=$CATALINA_PID; export JAVA_HOME=$JAVA_HOME; export JRE_HOME=$JRE_HOME; export LC_ALL=$LC_ALL; ${CATALINA_HOME}/bin/catalina.sh start"
                echo "Tomcat $USER started"
                exit 0
        else
          echo "CATALINA_BASE UNDEFINED"
          exit 1
        fi
        ;;

'stop')
        echo "Tomcat $USER stopping"
        ${EXECSTART} -c "export CATALINA_HOME=$CATALINA_HOME; export CATALINA_BASE=$CATALINA_BASE; export CATALINA_OPTS=\"$CATALINA_OPTS\"; export CATALINA_PID=$CATALINA_PID; export JAVA_HOME=$JAVA_HOME; export JRE_HOME=$JRE_HOME; export LC_ALL=$LC_ALL; ${CATALINA_HOME}/bin/catalina.sh stop -force"
        echo "Tomcat $USER stopped"

        exit 0
        ;;

'status')
	if [ -f $CATALINA_PID ]
	then
		PROCESSPID=`cat $CATALINA_PID`
		if [[ "`ps waux | grep $PROCESSPID | grep -v grep`" ]]
		then
			echo "Tomcat running with PID: $PROCESSPID"
      exit 0
		else
			echo "Tomcat not running"
      exit 1
		fi
	else
		echo "Tomcat not running"
    exit 1
	fi
	;;
'restart')
        $0 stop

        PROCESSPID=`cat $CATALINA_PID`
	      while [[ "`ps waux | grep $PROCESSPID | grep -v grep`" ]];
        do
          sleep 1
        done

	      $0 start

        exit 0
        ;;
*)
        echo "Tomcat $1 "
        $EXECSTART -c "export CATALINA_HOME=$CATALINA_HOME; export CATALINA_BASE=$CATALINA_BASE; export CATALINA_OPTS=\"$CATALINA_OPTS\"; export CATALINA_PID=$CATALINA_PID; export JAVA_HOME=$JAVA_HOME; export JRE_HOME=$JRE_HOME; export LC_ALL=$LC_ALL; ${CATALINA_HOME}/bin/catalina.sh $1"
        ;;
esac
